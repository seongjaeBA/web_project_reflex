{"version":3,"file":"addIdentifierToLinariaPreval.js","names":["createId","reference","getOrAddLinariaPreval","scope","rootScope","getProgramParent","programPath","path","object","getData","node","sourceType","prevalExport","expression","type","operator","left","computed","property","right","properties","inserted","pushContainer","get","declaration","declarations","id","init","kind","specifiers","setData","addIdentifierToLinariaPreval","name","newProperty","key","value","shorthand"],"sources":["../src/addIdentifierToLinariaPreval.ts"],"sourcesContent":["import type { NodePath, Scope } from '@babel/traverse';\nimport type {\n  ExportNamedDeclaration,\n  ExpressionStatement,\n  Identifier,\n  ObjectExpression,\n  ObjectProperty,\n  Program,\n} from '@babel/types';\n\nimport { createId } from './createId';\nimport { reference } from './scopeHelpers';\n\nexport function getOrAddLinariaPreval(\n  scope: Scope\n): NodePath<ObjectExpression> {\n  const rootScope = scope.getProgramParent();\n  const programPath = rootScope.path as NodePath<Program>;\n\n  let object = programPath.getData('__linariaPreval');\n  if (object) {\n    return object;\n  }\n\n  if (programPath.node.sourceType === 'script') {\n    // CJS exports.__linariaPreval = {};\n    const prevalExport: ExpressionStatement = {\n      expression: {\n        type: 'AssignmentExpression',\n        operator: '=',\n        left: {\n          computed: false,\n          object: createId('exports'),\n          property: createId('__linariaPreval'),\n          type: 'MemberExpression',\n        },\n        right: {\n          properties: [],\n          type: 'ObjectExpression',\n        },\n      },\n      type: 'ExpressionStatement',\n    };\n\n    const [inserted] = programPath.pushContainer('body', [prevalExport]);\n    object = inserted.get('expression.right') as NodePath<ObjectExpression>;\n  } else {\n    // ESM export const __linariaPreval = {};\n    const prevalExport: ExportNamedDeclaration = {\n      declaration: {\n        declarations: [\n          {\n            id: createId('__linariaPreval'),\n            init: {\n              properties: [],\n              type: 'ObjectExpression',\n            },\n            type: 'VariableDeclarator',\n          },\n        ],\n        kind: 'const',\n        type: 'VariableDeclaration',\n      },\n      specifiers: [],\n      type: 'ExportNamedDeclaration',\n    };\n\n    const [inserted] = programPath.pushContainer('body', [prevalExport]);\n    object = inserted.get(\n      'declaration.declarations.0.init'\n    ) as NodePath<ObjectExpression>;\n  }\n\n  programPath.setData('__linariaPreval', object);\n  return object;\n}\n\nexport function addIdentifierToLinariaPreval(scope: Scope, name: string) {\n  const rootScope = scope.getProgramParent();\n  const object = getOrAddLinariaPreval(rootScope);\n  const newProperty: ObjectProperty = {\n    type: 'ObjectProperty',\n    key: createId(name),\n    value: createId(name),\n    computed: false,\n    shorthand: false,\n  };\n\n  const [inserted] = object.pushContainer('properties', [newProperty]);\n  reference(inserted.get('value') as NodePath<Identifier>);\n}\n"],"mappings":"AAUA,SAASA,QAAQ,QAAQ,YAAY;AACrC,SAASC,SAAS,QAAQ,gBAAgB;AAE1C,OAAO,SAASC,qBAAqBA,CACnCC,KAAY,EACgB;EAC5B,MAAMC,SAAS,GAAGD,KAAK,CAACE,gBAAgB,CAAC,CAAC;EAC1C,MAAMC,WAAW,GAAGF,SAAS,CAACG,IAAyB;EAEvD,IAAIC,MAAM,GAAGF,WAAW,CAACG,OAAO,CAAC,iBAAiB,CAAC;EACnD,IAAID,MAAM,EAAE;IACV,OAAOA,MAAM;EACf;EAEA,IAAIF,WAAW,CAACI,IAAI,CAACC,UAAU,KAAK,QAAQ,EAAE;IAC5C;IACA,MAAMC,YAAiC,GAAG;MACxCC,UAAU,EAAE;QACVC,IAAI,EAAE,sBAAsB;QAC5BC,QAAQ,EAAE,GAAG;QACbC,IAAI,EAAE;UACJC,QAAQ,EAAE,KAAK;UACfT,MAAM,EAAER,QAAQ,CAAC,SAAS,CAAC;UAC3BkB,QAAQ,EAAElB,QAAQ,CAAC,iBAAiB,CAAC;UACrCc,IAAI,EAAE;QACR,CAAC;QACDK,KAAK,EAAE;UACLC,UAAU,EAAE,EAAE;UACdN,IAAI,EAAE;QACR;MACF,CAAC;MACDA,IAAI,EAAE;IACR,CAAC;IAED,MAAM,CAACO,QAAQ,CAAC,GAAGf,WAAW,CAACgB,aAAa,CAAC,MAAM,EAAE,CAACV,YAAY,CAAC,CAAC;IACpEJ,MAAM,GAAGa,QAAQ,CAACE,GAAG,CAAC,kBAAkB,CAA+B;EACzE,CAAC,MAAM;IACL;IACA,MAAMX,YAAoC,GAAG;MAC3CY,WAAW,EAAE;QACXC,YAAY,EAAE,CACZ;UACEC,EAAE,EAAE1B,QAAQ,CAAC,iBAAiB,CAAC;UAC/B2B,IAAI,EAAE;YACJP,UAAU,EAAE,EAAE;YACdN,IAAI,EAAE;UACR,CAAC;UACDA,IAAI,EAAE;QACR,CAAC,CACF;QACDc,IAAI,EAAE,OAAO;QACbd,IAAI,EAAE;MACR,CAAC;MACDe,UAAU,EAAE,EAAE;MACdf,IAAI,EAAE;IACR,CAAC;IAED,MAAM,CAACO,QAAQ,CAAC,GAAGf,WAAW,CAACgB,aAAa,CAAC,MAAM,EAAE,CAACV,YAAY,CAAC,CAAC;IACpEJ,MAAM,GAAGa,QAAQ,CAACE,GAAG,CACnB,iCACF,CAA+B;EACjC;EAEAjB,WAAW,CAACwB,OAAO,CAAC,iBAAiB,EAAEtB,MAAM,CAAC;EAC9C,OAAOA,MAAM;AACf;AAEA,OAAO,SAASuB,4BAA4BA,CAAC5B,KAAY,EAAE6B,IAAY,EAAE;EACvE,MAAM5B,SAAS,GAAGD,KAAK,CAACE,gBAAgB,CAAC,CAAC;EAC1C,MAAMG,MAAM,GAAGN,qBAAqB,CAACE,SAAS,CAAC;EAC/C,MAAM6B,WAA2B,GAAG;IAClCnB,IAAI,EAAE,gBAAgB;IACtBoB,GAAG,EAAElC,QAAQ,CAACgC,IAAI,CAAC;IACnBG,KAAK,EAAEnC,QAAQ,CAACgC,IAAI,CAAC;IACrBf,QAAQ,EAAE,KAAK;IACfmB,SAAS,EAAE;EACb,CAAC;EAED,MAAM,CAACf,QAAQ,CAAC,GAAGb,MAAM,CAACc,aAAa,CAAC,YAAY,EAAE,CAACW,WAAW,CAAC,CAAC;EACpEhC,SAAS,CAACoB,QAAQ,CAACE,GAAG,CAAC,OAAO,CAAyB,CAAC;AAC1D"}