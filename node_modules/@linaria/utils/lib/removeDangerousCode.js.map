{"version":3,"file":"removeDangerousCode.js","names":["_findIdentifiers","require","_isUnnecessaryReactCall","_interopRequireDefault","_scopeHelpers","_JSXElementsRemover","obj","__esModule","default","isGlobal","id","nonType","scope","name","node","hasBinding","hasGlobal","forbiddenGlobals","Set","isBrowserGlobal","has","getPropertyName","path","isIdentifier","isStringLiteral","value","removeDangerousCode","programPath","traverse","CallExpression","enter","p","isUnnecessaryReactCall","JSXElementsRemover","JSXElement","JSXFragment","MemberExpression","state","get","prop","windowScoped","add","globals","filter","removeWithRelated","MetaProperty","Identifier","find","parent","isTSTypeReference","parentPath","isUnaryExpression","operator","isTSTypeQuery","isClassProperty","isMemberExpression","key","push","exports"],"sources":["../src/removeDangerousCode.ts"],"sourcesContent":["import type { NodePath } from '@babel/core';\nimport type { Identifier, Program } from '@babel/types';\n\nimport { nonType } from './findIdentifiers';\nimport isUnnecessaryReactCall from './isUnnecessaryReactCall';\nimport { removeWithRelated } from './scopeHelpers';\nimport JSXElementsRemover from './visitors/JSXElementsRemover';\n\nconst isGlobal = (id: NodePath<Identifier>): boolean => {\n  if (!nonType(id)) {\n    return false;\n  }\n\n  const { scope } = id;\n  const { name } = id.node;\n  return !scope.hasBinding(name) && scope.hasGlobal(name);\n};\n\nconst forbiddenGlobals = new Set([\n  'XMLHttpRequest',\n  'clearImmediate',\n  'clearInterval',\n  'clearTimeout',\n  'document',\n  'fetch',\n  'localStorage',\n  'location',\n  'navigator',\n  'sessionStorage',\n  'setImmediate',\n  'setInterval',\n  'setTimeout',\n  'window',\n]);\n\nconst isBrowserGlobal = (id: NodePath<Identifier>) => {\n  return forbiddenGlobals.has(id.node.name) && isGlobal(id);\n};\n\nconst getPropertyName = (path: NodePath): string | null => {\n  if (path.isIdentifier()) {\n    return path.node.name;\n  }\n\n  if (path.isStringLiteral()) {\n    return path.node.value;\n  }\n\n  return null;\n};\n\nexport const removeDangerousCode = (programPath: NodePath<Program>) => {\n  programPath.traverse(\n    {\n      // JSX can be replaced with a dummy value,\n      // but we have to do it after we processed template tags.\n      CallExpression: {\n        enter(p) {\n          if (isUnnecessaryReactCall(p)) {\n            JSXElementsRemover(p);\n          }\n        },\n      },\n      JSXElement: {\n        enter: JSXElementsRemover,\n      },\n      JSXFragment: {\n        enter: JSXElementsRemover,\n      },\n      MemberExpression(p, state) {\n        const obj = p.get('object');\n        const prop = p.get('property');\n        if (!obj.isIdentifier({ name: 'window' })) {\n          return;\n        }\n\n        const name = getPropertyName(prop);\n        if (!name) {\n          return;\n        }\n\n        state.windowScoped.add(name);\n        // eslint-disable-next-line no-param-reassign\n        state.globals = state.globals.filter((id) => {\n          if (id.node.name === name) {\n            removeWithRelated([id]);\n            return false;\n          }\n\n          return true;\n        });\n      },\n      MetaProperty(p) {\n        // Remove all references to `import.meta`\n        removeWithRelated([p]);\n      },\n      Identifier(p, state) {\n        if (p.find((parent) => parent.isTSTypeReference())) {\n          // don't mess with TS type references\n          return;\n        }\n        if (isBrowserGlobal(p)) {\n          if (\n            p.find(\n              (parentPath) =>\n                parentPath.isUnaryExpression({ operator: 'typeof' }) ||\n                parentPath.isTSTypeQuery()\n            )\n          ) {\n            // Ignore `typeof window` expressions\n            return;\n          }\n\n          if (p.parentPath.isClassProperty()) {\n            // ignore class property decls\n            return;\n          }\n          if (p.parentPath.isMemberExpression() && p.key === 'property') {\n            // ignore e.g this.fetch()\n            // window.fetch will be handled by the windowScoped block below\n            return;\n          }\n\n          removeWithRelated([p]);\n\n          return;\n        }\n\n        if (state.windowScoped.has(p.node.name)) {\n          removeWithRelated([p]);\n        } else if (isGlobal(p)) {\n          state.globals.push(p);\n        }\n      },\n    },\n    {\n      globals: [] as NodePath<Identifier>[],\n      windowScoped: new Set<string>(),\n    }\n  );\n};\n"],"mappings":"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"}