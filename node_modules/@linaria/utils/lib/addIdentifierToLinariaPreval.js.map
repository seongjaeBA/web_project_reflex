{"version":3,"file":"addIdentifierToLinariaPreval.js","names":["_createId","require","_scopeHelpers","getOrAddLinariaPreval","scope","rootScope","getProgramParent","programPath","path","object","getData","node","sourceType","prevalExport","expression","type","operator","left","computed","createId","property","right","properties","inserted","pushContainer","get","declaration","declarations","id","init","kind","specifiers","setData","addIdentifierToLinariaPreval","name","newProperty","key","value","shorthand","reference"],"sources":["../src/addIdentifierToLinariaPreval.ts"],"sourcesContent":["import type { NodePath, Scope } from '@babel/traverse';\nimport type {\n  ExportNamedDeclaration,\n  ExpressionStatement,\n  Identifier,\n  ObjectExpression,\n  ObjectProperty,\n  Program,\n} from '@babel/types';\n\nimport { createId } from './createId';\nimport { reference } from './scopeHelpers';\n\nexport function getOrAddLinariaPreval(\n  scope: Scope\n): NodePath<ObjectExpression> {\n  const rootScope = scope.getProgramParent();\n  const programPath = rootScope.path as NodePath<Program>;\n\n  let object = programPath.getData('__linariaPreval');\n  if (object) {\n    return object;\n  }\n\n  if (programPath.node.sourceType === 'script') {\n    // CJS exports.__linariaPreval = {};\n    const prevalExport: ExpressionStatement = {\n      expression: {\n        type: 'AssignmentExpression',\n        operator: '=',\n        left: {\n          computed: false,\n          object: createId('exports'),\n          property: createId('__linariaPreval'),\n          type: 'MemberExpression',\n        },\n        right: {\n          properties: [],\n          type: 'ObjectExpression',\n        },\n      },\n      type: 'ExpressionStatement',\n    };\n\n    const [inserted] = programPath.pushContainer('body', [prevalExport]);\n    object = inserted.get('expression.right') as NodePath<ObjectExpression>;\n  } else {\n    // ESM export const __linariaPreval = {};\n    const prevalExport: ExportNamedDeclaration = {\n      declaration: {\n        declarations: [\n          {\n            id: createId('__linariaPreval'),\n            init: {\n              properties: [],\n              type: 'ObjectExpression',\n            },\n            type: 'VariableDeclarator',\n          },\n        ],\n        kind: 'const',\n        type: 'VariableDeclaration',\n      },\n      specifiers: [],\n      type: 'ExportNamedDeclaration',\n    };\n\n    const [inserted] = programPath.pushContainer('body', [prevalExport]);\n    object = inserted.get(\n      'declaration.declarations.0.init'\n    ) as NodePath<ObjectExpression>;\n  }\n\n  programPath.setData('__linariaPreval', object);\n  return object;\n}\n\nexport function addIdentifierToLinariaPreval(scope: Scope, name: string) {\n  const rootScope = scope.getProgramParent();\n  const object = getOrAddLinariaPreval(rootScope);\n  const newProperty: ObjectProperty = {\n    type: 'ObjectProperty',\n    key: createId(name),\n    value: createId(name),\n    computed: false,\n    shorthand: false,\n  };\n\n  const [inserted] = object.pushContainer('properties', [newProperty]);\n  reference(inserted.get('value') as NodePath<Identifier>);\n}\n"],"mappings":";;;;;;;AAUA,IAAAA,SAAA,GAAAC,OAAA;AACA,IAAAC,aAAA,GAAAD,OAAA;AAEO,SAASE,qBAAqBA,CACnCC,KAAY,EACgB;EAC5B,MAAMC,SAAS,GAAGD,KAAK,CAACE,gBAAgB,CAAC,CAAC;EAC1C,MAAMC,WAAW,GAAGF,SAAS,CAACG,IAAyB;EAEvD,IAAIC,MAAM,GAAGF,WAAW,CAACG,OAAO,CAAC,iBAAiB,CAAC;EACnD,IAAID,MAAM,EAAE;IACV,OAAOA,MAAM;EACf;EAEA,IAAIF,WAAW,CAACI,IAAI,CAACC,UAAU,KAAK,QAAQ,EAAE;IAC5C;IACA,MAAMC,YAAiC,GAAG;MACxCC,UAAU,EAAE;QACVC,IAAI,EAAE,sBAAsB;QAC5BC,QAAQ,EAAE,GAAG;QACbC,IAAI,EAAE;UACJC,QAAQ,EAAE,KAAK;UACfT,MAAM,EAAE,IAAAU,kBAAQ,EAAC,SAAS,CAAC;UAC3BC,QAAQ,EAAE,IAAAD,kBAAQ,EAAC,iBAAiB,CAAC;UACrCJ,IAAI,EAAE;QACR,CAAC;QACDM,KAAK,EAAE;UACLC,UAAU,EAAE,EAAE;UACdP,IAAI,EAAE;QACR;MACF,CAAC;MACDA,IAAI,EAAE;IACR,CAAC;IAED,MAAM,CAACQ,QAAQ,CAAC,GAAGhB,WAAW,CAACiB,aAAa,CAAC,MAAM,EAAE,CAACX,YAAY,CAAC,CAAC;IACpEJ,MAAM,GAAGc,QAAQ,CAACE,GAAG,CAAC,kBAAkB,CAA+B;EACzE,CAAC,MAAM;IACL;IACA,MAAMZ,YAAoC,GAAG;MAC3Ca,WAAW,EAAE;QACXC,YAAY,EAAE,CACZ;UACEC,EAAE,EAAE,IAAAT,kBAAQ,EAAC,iBAAiB,CAAC;UAC/BU,IAAI,EAAE;YACJP,UAAU,EAAE,EAAE;YACdP,IAAI,EAAE;UACR,CAAC;UACDA,IAAI,EAAE;QACR,CAAC,CACF;QACDe,IAAI,EAAE,OAAO;QACbf,IAAI,EAAE;MACR,CAAC;MACDgB,UAAU,EAAE,EAAE;MACdhB,IAAI,EAAE;IACR,CAAC;IAED,MAAM,CAACQ,QAAQ,CAAC,GAAGhB,WAAW,CAACiB,aAAa,CAAC,MAAM,EAAE,CAACX,YAAY,CAAC,CAAC;IACpEJ,MAAM,GAAGc,QAAQ,CAACE,GAAG,CACnB,iCACF,CAA+B;EACjC;EAEAlB,WAAW,CAACyB,OAAO,CAAC,iBAAiB,EAAEvB,MAAM,CAAC;EAC9C,OAAOA,MAAM;AACf;AAEO,SAASwB,4BAA4BA,CAAC7B,KAAY,EAAE8B,IAAY,EAAE;EACvE,MAAM7B,SAAS,GAAGD,KAAK,CAACE,gBAAgB,CAAC,CAAC;EAC1C,MAAMG,MAAM,GAAGN,qBAAqB,CAACE,SAAS,CAAC;EAC/C,MAAM8B,WAA2B,GAAG;IAClCpB,IAAI,EAAE,gBAAgB;IACtBqB,GAAG,EAAE,IAAAjB,kBAAQ,EAACe,IAAI,CAAC;IACnBG,KAAK,EAAE,IAAAlB,kBAAQ,EAACe,IAAI,CAAC;IACrBhB,QAAQ,EAAE,KAAK;IACfoB,SAAS,EAAE;EACb,CAAC;EAED,MAAM,CAACf,QAAQ,CAAC,GAAGd,MAAM,CAACe,aAAa,CAAC,YAAY,EAAE,CAACW,WAAW,CAAC,CAAC;EACpE,IAAAI,uBAAS,EAAChB,QAAQ,CAACE,GAAG,CAAC,OAAO,CAAyB,CAAC;AAC1D"}