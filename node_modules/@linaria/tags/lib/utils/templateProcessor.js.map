{"version":3,"file":"templateProcessor.js","names":["_utils","require","_getVariableName","_stripLines","_interopRequireDefault","_throwIfInvalid","_toCSS","_interopRequireWildcard","_units","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","unitRegex","RegExp","units","join","templateProcessor","tagProcessor","template","valueCache","variableNameConfig","sourceMapReplacements","isReferenced","cssText","item","lastTemplateElementLocation","shift","value","cooked","loc","ex","end","beforeLength","length","next","start","line","column","name","kind","ValueType","FUNCTION","_next$value$cooked","matches","match","_next$value$cooked$su","_next$value$cooked2","_unit$length","unit","varId","addInterpolation","source","getVariableName","substring","e","Error","buildCodeFrameError","message","throwIfInvalid","isValidValue","bind","undefined","hasMeta","__linaria","className","isCSSable","stripLines","toCSS","push","original","rules","extractRules","location","includes"],"sources":["../../src/utils/templateProcessor.ts"],"sourcesContent":["/* eslint-disable no-continue */\n/**\n * This file handles transforming template literals to class names or styled components and generates CSS content.\n * It uses CSS code from template literals and evaluated values of lazy dependencies stored in ValueCache.\n */\n\nimport type { TemplateElement, SourceLocation } from '@babel/types';\n\nimport type { ExpressionValue, Replacements } from '@linaria/utils';\nimport { hasMeta, ValueType } from '@linaria/utils';\n\nimport type TaggedTemplateProcessor from '../TaggedTemplateProcessor';\nimport type { ValueCache, Rules } from '../types';\n\nimport { getVariableName } from './getVariableName';\nimport stripLines from './stripLines';\nimport throwIfInvalid from './throwIfInvalid';\nimport toCSS, { isCSSable } from './toCSS';\nimport type { IOptions } from './types';\nimport { units } from './units';\n\n// Match any valid CSS units followed by a separator such as ;, newline etc.\nconst unitRegex = new RegExp(`^(?:${units.join('|')})\\\\b`);\n\nexport default function templateProcessor(\n  tagProcessor: TaggedTemplateProcessor,\n  [...template]: (TemplateElement | ExpressionValue)[],\n  valueCache: ValueCache,\n  variableNameConfig: IOptions['variableNameConfig'] | undefined\n): [rules: Rules, sourceMapReplacements: Replacements] | null {\n  const sourceMapReplacements: Replacements = [];\n  // Check if the variable is referenced anywhere for basic DCE\n  // Only works when it's assigned to a variable\n  const { isReferenced } = tagProcessor;\n\n  // Serialize the tagged template literal to a string\n  let cssText = '';\n\n  let item: TemplateElement | ExpressionValue | undefined;\n  let lastTemplateElementLocation: SourceLocation | null | undefined;\n  // eslint-disable-next-line no-cond-assign\n  while ((item = template.shift())) {\n    if ('type' in item) {\n      // It's a template element\n      cssText += item.value.cooked;\n      lastTemplateElementLocation = item.loc;\n      continue;\n    }\n\n    // It's an expression\n    const { ex } = item;\n\n    const { end } = ex.loc!;\n    const beforeLength = cssText.length;\n\n    // The location will be end of the current string to start of next string\n    const next = template[0] as TemplateElement; // template[0] is the next template element\n    const loc = {\n      // +1 because an expression location always shows 1 column before\n      start: {\n        line: lastTemplateElementLocation!.end.line,\n        column: lastTemplateElementLocation!.end.column + 1,\n      },\n      end: next\n        ? { line: next.loc!.start.line, column: next.loc!.start.column }\n        : { line: end.line, column: end.column + 1 },\n    };\n\n    const value = 'value' in item ? item.value : valueCache.get(item.ex.name);\n\n    // Is it props based interpolation?\n    if (item.kind === ValueType.FUNCTION || typeof value === 'function') {\n      // Check if previous expression was a CSS variable that we replaced\n      // If it has a unit after it, we need to move the unit into the interpolation\n      // e.g. `var(--size)px` should actually be `var(--size)`\n      // So we check if the current text starts with a unit, and add the unit to the previous interpolation\n      // Another approach would be `calc(var(--size) * 1px), but some browsers don't support all units\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=956573\n      const matches = next.value.cooked?.match(unitRegex);\n\n      try {\n        if (matches) {\n          template.shift();\n          const [unit] = matches;\n\n          const varId = tagProcessor.addInterpolation(\n            item.ex,\n            cssText,\n            item.source,\n            unit\n          );\n          cssText += getVariableName(varId, variableNameConfig);\n\n          cssText += next.value.cooked?.substring(unit?.length ?? 0) ?? '';\n        } else {\n          const varId = tagProcessor.addInterpolation(\n            item.ex,\n            cssText,\n            item.source\n          );\n          cssText += getVariableName(varId, variableNameConfig);\n        }\n      } catch (e) {\n        if (e instanceof Error) {\n          throw item.buildCodeFrameError(e.message);\n        }\n\n        throw e;\n      }\n    } else {\n      throwIfInvalid(\n        tagProcessor.isValidValue.bind(tagProcessor),\n        value,\n        item,\n        item.source\n      );\n\n      if (value !== undefined && typeof value !== 'function') {\n        // Skip the blank string instead of throw ing an error\n        if (value === '') {\n          continue;\n        }\n\n        if (hasMeta(value)) {\n          // If it's a React component wrapped in styled, get the class name\n          // Useful for interpolating components\n          cssText += `.${value.__linaria.className}`;\n        } else if (isCSSable(value)) {\n          // If it's a plain object or an array, convert it to a CSS string\n          cssText += stripLines(loc, toCSS(value));\n        } else {\n          // For anything else, assume it'll be stringified\n          cssText += stripLines(loc, value);\n        }\n\n        sourceMapReplacements.push({\n          original: loc,\n          length: cssText.length - beforeLength,\n        });\n      }\n    }\n  }\n\n  const rules = tagProcessor.extractRules(\n    valueCache,\n    cssText,\n    tagProcessor.location\n  );\n\n  // tagProcessor.doRuntimeReplacement(classes);\n  if (!isReferenced && !cssText.includes(':global')) {\n    return null;\n  }\n\n  // eslint-disable-next-line no-param-reassign\n  return [rules, sourceMapReplacements];\n}\n"],"mappings":"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"}